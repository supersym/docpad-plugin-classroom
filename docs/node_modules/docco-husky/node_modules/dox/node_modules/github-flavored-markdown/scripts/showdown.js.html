<!DOCTYPE html><html><head><title>showdown.js</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../../../../../../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../../../../../../../index.html" class="source"><span class="file_name">README</span></a><a href="../../../../../../../.././test/a.js.html" class="source "><span class="base_path">. / test / </span><span class="file_name">a.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/lib/docco.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / lib / </span><span class="file_name">docco.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/test/Foo.java.html" class="source "><span class="base_path">. / node_modules / docco-husky / test / </span><span class="file_name">Foo.java</span></a><a href="../../../../../../../.././node_modules/docco-husky/test/test.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / test / </span><span class="file_name">test.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/vendor/showdown.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / vendor / </span><span class="file_name">showdown.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/runtime.min.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / </span><span class="file_name">runtime.min.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/testing/index.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / testing / </span><span class="file_name">index.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/lexer.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / </span><span class="file_name">lexer.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/doctypes.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / </span><span class="file_name">doctypes.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/jade.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / </span><span class="file_name">jade.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/nodes/doctype.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / nodes / </span><span class="file_name">doctype.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/nodes/code.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / nodes / </span><span class="file_name">code.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/nodes/case.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / nodes / </span><span class="file_name">case.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/nodes/index.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / nodes / </span><span class="file_name">index.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/nodes/block.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / nodes / </span><span class="file_name">block.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/nodes/text.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / nodes / </span><span class="file_name">text.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/nodes/tag.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / nodes / </span><span class="file_name">tag.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/nodes/filter.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / nodes / </span><span class="file_name">filter.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/nodes/block-comment.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / nodes / </span><span class="file_name">block-comment.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/nodes/each.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / nodes / </span><span class="file_name">each.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/nodes/mixin.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / nodes / </span><span class="file_name">mixin.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/nodes/literal.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / nodes / </span><span class="file_name">literal.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/nodes/node.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / nodes / </span><span class="file_name">node.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/nodes/comment.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / nodes / </span><span class="file_name">comment.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/parser.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / </span><span class="file_name">parser.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/compiler.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / </span><span class="file_name">compiler.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/utils.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / </span><span class="file_name">utils.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/runtime.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / </span><span class="file_name">runtime.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/inline-tags.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / </span><span class="file_name">inline-tags.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/filters.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / </span><span class="file_name">filters.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/lib/self-closing.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / lib / </span><span class="file_name">self-closing.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/index.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / </span><span class="file_name">index.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/jade.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / </span><span class="file_name">jade.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/runtime.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / </span><span class="file_name">runtime.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/jade.min.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / </span><span class="file_name">jade.min.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/node_modules/commander/lib/commander.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / node_modules / commander / lib / </span><span class="file_name">commander.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/node_modules/commander/index.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / node_modules / commander / </span><span class="file_name">index.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/node_modules/mkdirp/index.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / node_modules / mkdirp / </span><span class="file_name">index.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/node_modules/mkdirp/test/race.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / node_modules / mkdirp / test / </span><span class="file_name">race.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/node_modules/mkdirp/test/clobber.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / node_modules / mkdirp / test / </span><span class="file_name">clobber.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/node_modules/mkdirp/test/sync.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / node_modules / mkdirp / test / </span><span class="file_name">sync.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/node_modules/mkdirp/test/return_sync.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / node_modules / mkdirp / test / </span><span class="file_name">return_sync.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/node_modules/mkdirp/test/root.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / node_modules / mkdirp / test / </span><span class="file_name">root.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/node_modules/mkdirp/test/umask_sync.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / node_modules / mkdirp / test / </span><span class="file_name">umask_sync.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/node_modules/mkdirp/test/rel.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / node_modules / mkdirp / test / </span><span class="file_name">rel.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/node_modules/mkdirp/test/return.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / node_modules / mkdirp / test / </span><span class="file_name">return.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/node_modules/mkdirp/test/mkdirp.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / node_modules / mkdirp / test / </span><span class="file_name">mkdirp.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/node_modules/mkdirp/test/perm_sync.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / node_modules / mkdirp / test / </span><span class="file_name">perm_sync.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/node_modules/mkdirp/test/perm.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / node_modules / mkdirp / test / </span><span class="file_name">perm.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/node_modules/mkdirp/test/chmod.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / node_modules / mkdirp / test / </span><span class="file_name">chmod.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/node_modules/mkdirp/test/umask.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / node_modules / mkdirp / test / </span><span class="file_name">umask.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/jade/node_modules/mkdirp/examples/pow.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / jade / node_modules / mkdirp / examples / </span><span class="file_name">pow.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/walk/node-type-emitter.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / walk / </span><span class="file_name">node-type-emitter.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/walk/walk-async-only.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / walk / </span><span class="file_name">walk-async-only.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/walk/node_modules/forEachAsync/node_modules/sequence/sequence.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / walk / node_modules / forEachAsync / node_modules / sequence / </span><span class="file_name">sequence.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/walk/node_modules/forEachAsync/forEachAsync.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / walk / node_modules / forEachAsync / </span><span class="file_name">forEachAsync.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/walk/walk.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / walk / </span><span class="file_name">walk.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/gravatar/lib/gravatar.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / gravatar / lib / </span><span class="file_name">gravatar.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/gravatar/index.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / gravatar / </span><span class="file_name">index.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/gravatar/test/gravatar.test.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / gravatar / test / </span><span class="file_name">gravatar.test.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/dox/lib/utils.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / dox / lib / </span><span class="file_name">utils.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/dox/lib/dox.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / dox / lib / </span><span class="file_name">dox.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/dox/index.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / dox / </span><span class="file_name">index.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/dox/node_modules/commander/lib/commander.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / dox / node_modules / commander / lib / </span><span class="file_name">commander.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/dox/node_modules/commander/index.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / dox / node_modules / commander / </span><span class="file_name">index.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/dox/node_modules/github-flavored-markdown/scripts/showdown.js.html" class="source selected"><span class="base_path">. / node_modules / docco-husky / node_modules / dox / node_modules / github-flavored-markdown / scripts / </span><span class="file_name">showdown.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/dox/node_modules/github-flavored-markdown/scripts/preview.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / dox / node_modules / github-flavored-markdown / scripts / </span><span class="file_name">preview.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/dox/node_modules/github-flavored-markdown/code.rb.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / dox / node_modules / github-flavored-markdown / </span><span class="file_name">code.rb</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/coffee-script/lib/coffee-script/scope.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / coffee-script / lib / coffee-script / </span><span class="file_name">scope.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/coffee-script/lib/coffee-script/helpers.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / coffee-script / lib / coffee-script / </span><span class="file_name">helpers.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/coffee-script/lib/coffee-script/lexer.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / coffee-script / lib / coffee-script / </span><span class="file_name">lexer.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/coffee-script/lib/coffee-script/index.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / coffee-script / lib / coffee-script / </span><span class="file_name">index.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/coffee-script/lib/coffee-script/repl.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / coffee-script / lib / coffee-script / </span><span class="file_name">repl.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/coffee-script/lib/coffee-script/rewriter.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / coffee-script / lib / coffee-script / </span><span class="file_name">rewriter.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/coffee-script/lib/coffee-script/parser.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / coffee-script / lib / coffee-script / </span><span class="file_name">parser.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/coffee-script/lib/coffee-script/cake.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / coffee-script / lib / coffee-script / </span><span class="file_name">cake.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/coffee-script/lib/coffee-script/grammar.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / coffee-script / lib / coffee-script / </span><span class="file_name">grammar.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/coffee-script/lib/coffee-script/coffee-script.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / coffee-script / lib / coffee-script / </span><span class="file_name">coffee-script.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/coffee-script/lib/coffee-script/command.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / coffee-script / lib / coffee-script / </span><span class="file_name">command.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/coffee-script/lib/coffee-script/nodes.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / coffee-script / lib / coffee-script / </span><span class="file_name">nodes.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/coffee-script/lib/coffee-script/browser.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / coffee-script / lib / coffee-script / </span><span class="file_name">browser.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/coffee-script/lib/coffee-script/optparse.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / coffee-script / lib / coffee-script / </span><span class="file_name">optparse.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/underscore/index.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / underscore / </span><span class="file_name">index.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/underscore/underscore-min.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / underscore / </span><span class="file_name">underscore-min.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/node_modules/underscore/underscore.js.html" class="source "><span class="base_path">. / node_modules / docco-husky / node_modules / underscore / </span><span class="file_name">underscore.js</span></a><a href="../../../../../../../.././node_modules/docco-husky/src/docco.coffee.html" class="source "><span class="base_path">. / node_modules / docco-husky / src / </span><span class="file_name">docco.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>showdown.js</h1><div class="filepath">./node_modules/docco-husky/node_modules/dox/node_modules/github-flavored-markdown/scripts/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div><p>showdown.js -- A javascript port of Markdown.</p>

<p>Copyright (c) 2007 John Fraser.</p>

<p>Original Markdown Copyright (c) 2004-2005 John Gruber
  <a href="http://daringfireball.net/projects/markdown/">http://daringfireball.net/projects/markdown/</a></p>

<p>Redistributable under a BSD-style open source license.
See license.txt for more information.</p>

<p>The full source distribution is at:</p>

<pre><code>        A A L
        T C A
        T K B
</code></pre>

<p><a href="http://www.attacklab.net/">http://www.attacklab.net/</a></p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>Wherever possible, Showdown is a straight, line-by-line port
of the Perl version of Markdown.</p>

<p>This is not a normal parser design; it's basically just a
series of string substitutions.  It's hard to read and
maintain this way,  but keeping Showdown close to the original
design makes it easier to port new features.</p>

<p>More importantly, Showdown behaves like markdown.pl in most
edge cases.  So web applications can do client-side preview
in Javascript, and then build identical HTML on the server.</p>

<p>This port needs the new RegExp functionality of ECMA 262,
3rd Edition (i.e. Javascript 1.5).  Most modern web browsers
should do fine.  Even with the new regular expression features,
We do a lot of work to emulate Perl's regex functionality.
The tricky changes in this file mostly have the "attacklab:"
label.  Major or self-explanatory changes don't.</p>

<p>Smart diff tools like Araxis Merge will be able to match up
this file with markdown.pl in a useful way.  A little tweaking
helps: in a copy of markdown.pl, replace "#" with "//" and
replace "$text" with "text".  Be sure to ignore whitespace
and line endings.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Showdown usage:</p>

<p>var text = "Markdown <em>rocks</em>.";</p>

<p>var converter = new Showdown.converter();
  var html = converter.makeHtml(text);</p>

<p>alert(html);</p>

<p>Note: move the sample code to the bottom of this
file before uncommenting it.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><hr />

<p>GitHub Flavored Markdown modifications by Tekkub
http://github.github.com/github-flavored-markdown/</p>

<p>Modifications are tagged with "GFM"</p>

<hr />
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><hr />

<p>Node.JS port by Isaac Z. Schlueter</p>

<p>Modifications are tagged with "isaacs"</p>

<hr />
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Showdown namespace</p>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Showdown</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>isaacs: export the Showdown object</p>
</td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">exports</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Showdown</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">;</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>isaacs: expose top-level parse() method, like other to-html parsers.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">Showdown</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">md</span><span class="p">,</span> <span class="nx">gh</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">converter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Showdown</span><span class="p">.</span><span class="nx">converter</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">converter</span><span class="p">.</span><span class="nx">makeHtml</span><span class="p">(</span><span class="nx">md</span><span class="p">,</span> <span class="nx">gh</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>isaacs: Declare "GitHub" object in here, since Node modules
execute in a closure or separate context, rather than right
in the global scope.  If in the browser, this does nothing.</p>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">GitHub</span><span class="p">;</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>converter</p>

<p>Wraps all "globals" so that the only thing
exposed is makeHtml().</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">Showdown</span><span class="p">.</span><span class="nx">converter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>Globals:</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>Global hashes, used by various utility routines</p>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">g_urls</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">g_titles</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">g_html_blocks</span><span class="p">;</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>Used to track when we're inside an ordered or unordered list
(see _ProcessListItems() for details):</p>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">g_list_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>isaacs - Allow passing in the GitHub object as an argument.</p>
</td><td class="code"><div class="highlight"><pre><span class="k">this</span><span class="p">.</span><span class="nx">makeHtml</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">gh</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">gh</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">gh</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="nx">gh</span> <span class="o">=</span> <span class="p">{</span><span class="nx">nameWithOwner</span><span class="o">:</span><span class="nx">gh</span><span class="p">};</span>
    <span class="nx">GitHub</span> <span class="o">=</span> <span class="nx">gh</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>Main function. The order in which other subs are called here is
essential. Link and image substitutions need to happen before
_EscapeSpecialCharsWithinTagAttributes(), so that any *'s or _'s in the <a>
and <img> tags get encoded.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>Clear the global hashes. If we don't clear these, you get conflicts
from other articles when generating a page which contains more than
one article (e.g. an index page that shows the N most recent
articles):</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">g_urls</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
  <span class="nx">g_titles</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
  <span class="nx">g_html_blocks</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>attacklab: Replace ~ with ~T
This lets us use tilde as an escape char to avoid md5 hashes
The choice of character is arbitray; anything that isn't
magic in Markdown will work.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/~/g</span><span class="p">,</span><span class="s2">&quot;~T&quot;</span><span class="p">);</span></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>attacklab: Replace $ with ~D
RegExp interprets $ as a special character
when it's in a replacement string</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\$/g</span><span class="p">,</span><span class="s2">&quot;~D&quot;</span><span class="p">);</span></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><p>Standardize line endings</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\r\n/g</span><span class="p">,</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span> <span class="c1">// DOS to Unix</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\r/g</span><span class="p">,</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span> <span class="c1">// Mac to Unix</span></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><p>Make sure text begins and ends with a couple of newlines:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="s2">&quot;\n\n&quot;</span> <span class="o">+</span> <span class="nx">text</span> <span class="o">+</span> <span class="s2">&quot;\n\n&quot;</span><span class="p">;</span></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>Convert all tabs to spaces.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_Detab</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><p>Strip any lines consisting only of spaces and tabs.
This makes subsequent regexen easier to write, because we can
match consecutive blank lines with /\n+/ instead of something
contorted like /[ \t]*\n+/ .</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^[ \t]+$/mg</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><p>Turn block-level HTML blocks into hash entries</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_HashHTMLBlocks</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>Strip link definitions, store in hashes.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_StripLinkDefinitions</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>

  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_RunBlockGamut</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>

  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_UnescapeSpecialChars</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><p>attacklab: Restore dollar signs</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/~D/g</span><span class="p">,</span><span class="s2">&quot;$$&quot;</span><span class="p">);</span></pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><p>attacklab: Restore tildes</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/~T/g</span><span class="p">,</span><span class="s2">&quot;~&quot;</span><span class="p">);</span></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a href="#section-27" class="pilcrow">&#182;</a></div><p><em>* GFM *</em>  Auto-link URLs and emails</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/https?\:\/\/[^&quot;\s\&lt;\&gt;]*[^.,;&#39;&quot;&gt;\:\s\&lt;\&gt;\)\]\!]/g</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">matchIndex</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">matchIndex</span><span class="p">),</span> <span class="nx">right</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">matchIndex</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">left</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/&lt;[^&gt;]+$/</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">right</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^[^&gt;]*&gt;/</span><span class="p">))</span> <span class="p">{</span><span class="k">return</span> <span class="nx">wholeMatch</span><span class="p">}</span>
    <span class="k">return</span> <span class="s2">&quot;&lt;a href=&#39;&quot;</span> <span class="o">+</span> <span class="nx">wholeMatch</span> <span class="o">+</span> <span class="s2">&quot;&#39;&gt;&quot;</span> <span class="o">+</span> <span class="nx">wholeMatch</span> <span class="o">+</span> <span class="s2">&quot;&lt;/a&gt;&quot;</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[a-z0-9_\-+=.]+@[a-z0-9\-]+(\.[a-z0-9-]+)+/ig</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">){</span><span class="k">return</span> <span class="s2">&quot;&lt;a href=&#39;mailto:&quot;</span> <span class="o">+</span> <span class="nx">wholeMatch</span> <span class="o">+</span> <span class="s2">&quot;&#39;&gt;&quot;</span> <span class="o">+</span> <span class="nx">wholeMatch</span> <span class="o">+</span> <span class="s2">&quot;&lt;/a&gt;&quot;</span><span class="p">;});</span></pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a href="#section-28" class="pilcrow">&#182;</a></div><p><em>* GFM *</em> Auto-link sha1 if GitHub.nameWithOwner is defined</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[a-f0-9]{40}/ig</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">matchIndex</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">GitHub</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">||</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">GitHub</span><span class="p">.</span><span class="nx">nameWithOwner</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">wholeMatch</span><span class="p">;}</span>
    <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">matchIndex</span><span class="p">),</span> <span class="nx">right</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">matchIndex</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">left</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/@$/</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">left</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/&lt;[^&gt;]+$/</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">right</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^[^&gt;]*&gt;/</span><span class="p">)))</span> <span class="p">{</span><span class="k">return</span> <span class="nx">wholeMatch</span><span class="p">;}</span>
    <span class="k">return</span> <span class="s2">&quot;&lt;a href=&#39;http://github.com/&quot;</span> <span class="o">+</span> <span class="nx">GitHub</span><span class="p">.</span><span class="nx">nameWithOwner</span> <span class="o">+</span> <span class="s2">&quot;/commit/&quot;</span> <span class="o">+</span> <span class="nx">wholeMatch</span> <span class="o">+</span> <span class="s2">&quot;&#39;&gt;&quot;</span> <span class="o">+</span> <span class="nx">wholeMatch</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&lt;/a&gt;&quot;</span><span class="p">;</span>
  <span class="p">});</span></pre></div></td></tr><tr id="section-29"><td class="docs"><div class="pilwrap"><a href="#section-29" class="pilcrow">&#182;</a></div><p><em>* GFM *</em> Auto-link user@sha1 if GitHub.nameWithOwner is defined</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([a-z0-9_\-+=.]+)@([a-f0-9]{40})/ig</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">username</span><span class="p">,</span><span class="nx">sha</span><span class="p">,</span><span class="nx">matchIndex</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">GitHub</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">||</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">GitHub</span><span class="p">.</span><span class="nx">nameWithOwner</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">wholeMatch</span><span class="p">;}</span>
    <span class="nx">GitHub</span><span class="p">.</span><span class="nx">repoName</span> <span class="o">=</span> <span class="nx">GitHub</span><span class="p">.</span><span class="nx">repoName</span> <span class="o">||</span> <span class="nx">_GetRepoName</span><span class="p">()</span>
    <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">matchIndex</span><span class="p">),</span> <span class="nx">right</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">matchIndex</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">left</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">left</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/&lt;[^&gt;]+$/</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">right</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^[^&gt;]*&gt;/</span><span class="p">)))</span> <span class="p">{</span><span class="k">return</span> <span class="nx">wholeMatch</span><span class="p">;}</span>
    <span class="k">return</span> <span class="s2">&quot;&lt;a href=&#39;http://github.com/&quot;</span> <span class="o">+</span> <span class="nx">username</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">GitHub</span><span class="p">.</span><span class="nx">repoName</span> <span class="o">+</span> <span class="s2">&quot;/commit/&quot;</span> <span class="o">+</span> <span class="nx">sha</span> <span class="o">+</span> <span class="s2">&quot;&#39;&gt;&quot;</span> <span class="o">+</span> <span class="nx">username</span> <span class="o">+</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="nx">sha</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&lt;/a&gt;&quot;</span><span class="p">;</span>
  <span class="p">});</span></pre></div></td></tr><tr id="section-30"><td class="docs"><div class="pilwrap"><a href="#section-30" class="pilcrow">&#182;</a></div><p><em>* GFM *</em> Auto-link user/repo@sha1</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([a-z0-9_\-+=.]+\/[a-z0-9_\-+=.]+)@([a-f0-9]{40})/ig</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">repo</span><span class="p">,</span><span class="nx">sha</span><span class="p">){</span>
    <span class="k">return</span> <span class="s2">&quot;&lt;a href=&#39;http://github.com/&quot;</span> <span class="o">+</span> <span class="nx">repo</span> <span class="o">+</span> <span class="s2">&quot;/commit/&quot;</span> <span class="o">+</span> <span class="nx">sha</span> <span class="o">+</span> <span class="s2">&quot;&#39;&gt;&quot;</span> <span class="o">+</span> <span class="nx">repo</span> <span class="o">+</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="nx">sha</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&lt;/a&gt;&quot;</span><span class="p">;</span>
  <span class="p">});</span></pre></div></td></tr><tr id="section-31"><td class="docs"><div class="pilwrap"><a href="#section-31" class="pilcrow">&#182;</a></div><p><em>* GFM *</em> Auto-link #issue if GitHub.nameWithOwner is defined</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/#([0-9]+)/ig</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">issue</span><span class="p">,</span><span class="nx">matchIndex</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">GitHub</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">||</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">GitHub</span><span class="p">.</span><span class="nx">nameWithOwner</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">wholeMatch</span><span class="p">;}</span>
    <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">matchIndex</span><span class="p">),</span> <span class="nx">right</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">matchIndex</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">left</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="o">||</span> <span class="nx">left</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/[a-z0-9_\-+=.]$/</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">left</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/&lt;[^&gt;]+$/</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">right</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^[^&gt;]*&gt;/</span><span class="p">)))</span> <span class="p">{</span><span class="k">return</span> <span class="nx">wholeMatch</span><span class="p">;}</span>
    <span class="k">return</span> <span class="s2">&quot;&lt;a href=&#39;http://github.com/&quot;</span> <span class="o">+</span> <span class="nx">GitHub</span><span class="p">.</span><span class="nx">nameWithOwner</span> <span class="o">+</span> <span class="s2">&quot;/issues/#issue/&quot;</span> <span class="o">+</span> <span class="nx">issue</span> <span class="o">+</span> <span class="s2">&quot;&#39;&gt;&quot;</span> <span class="o">+</span> <span class="nx">wholeMatch</span> <span class="o">+</span> <span class="s2">&quot;&lt;/a&gt;&quot;</span><span class="p">;</span>
  <span class="p">});</span></pre></div></td></tr><tr id="section-32"><td class="docs"><div class="pilwrap"><a href="#section-32" class="pilcrow">&#182;</a></div><p><em>* GFM *</em> Auto-link user#issue if GitHub.nameWithOwner is defined</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([a-z0-9_\-+=.]+)#([0-9]+)/ig</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">username</span><span class="p">,</span><span class="nx">issue</span><span class="p">,</span><span class="nx">matchIndex</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">GitHub</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">||</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">GitHub</span><span class="p">.</span><span class="nx">nameWithOwner</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">wholeMatch</span><span class="p">;}</span>
    <span class="nx">GitHub</span><span class="p">.</span><span class="nx">repoName</span> <span class="o">=</span> <span class="nx">GitHub</span><span class="p">.</span><span class="nx">repoName</span> <span class="o">||</span> <span class="nx">_GetRepoName</span><span class="p">()</span>
    <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">matchIndex</span><span class="p">),</span> <span class="nx">right</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">matchIndex</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">left</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">left</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/&lt;[^&gt;]+$/</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">right</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^[^&gt;]*&gt;/</span><span class="p">)))</span> <span class="p">{</span><span class="k">return</span> <span class="nx">wholeMatch</span><span class="p">;}</span>
    <span class="k">return</span> <span class="s2">&quot;&lt;a href=&#39;http://github.com/&quot;</span> <span class="o">+</span> <span class="nx">username</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">GitHub</span><span class="p">.</span><span class="nx">repoName</span> <span class="o">+</span> <span class="s2">&quot;/issues/#issue/&quot;</span> <span class="o">+</span> <span class="nx">issue</span> <span class="o">+</span> <span class="s2">&quot;&#39;&gt;&quot;</span> <span class="o">+</span> <span class="nx">wholeMatch</span> <span class="o">+</span> <span class="s2">&quot;&lt;/a&gt;&quot;</span><span class="p">;</span>
  <span class="p">});</span></pre></div></td></tr><tr id="section-33"><td class="docs"><div class="pilwrap"><a href="#section-33" class="pilcrow">&#182;</a></div><p><em>* GFM *</em> Auto-link user/repo#issue</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([a-z0-9_\-+=.]+\/[a-z0-9_\-+=.]+)#([0-9]+)/ig</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">repo</span><span class="p">,</span><span class="nx">issue</span><span class="p">){</span>
    <span class="k">return</span> <span class="s2">&quot;&lt;a href=&#39;http://github.com/&quot;</span> <span class="o">+</span> <span class="nx">repo</span> <span class="o">+</span> <span class="s2">&quot;/issues/#issue/&quot;</span> <span class="o">+</span> <span class="nx">issue</span> <span class="o">+</span> <span class="s2">&quot;&#39;&gt;&quot;</span> <span class="o">+</span> <span class="nx">wholeMatch</span> <span class="o">+</span> <span class="s2">&quot;&lt;/a&gt;&quot;</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">_GetRepoName</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">GitHub</span><span class="p">.</span><span class="nx">nameWithOwner</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^.+\/(.+)$/</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">_StripLinkDefinitions</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-34"><td class="docs"><div class="pilwrap"><a href="#section-34" class="pilcrow">&#182;</a></div><p>Strips link definitions from text, stores the URLs and titles in
hash references.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-35"><td class="docs"><div class="pilwrap"><a href="#section-35" class="pilcrow">&#182;</a></div><p>Link defs are in the form: ^[id]: url "optional title"</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-36"><td class="docs"><div class="pilwrap"><a href="#section-36" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>var text = text.replace(/<br />                ^[ ]{0,3}[(.+)]:  // id = $1  attacklab: g_tab_width - 1<br />                  [ \t]*<br />                  \n?               // maybe <em>one</em> newline<br />                  [ \t]*<br />                <?(\S+?)>?          // url = $2<br />                  [ \t]*<br />                  \n?               // maybe one newline<br />                  [ \t]*<br />                (?:<br />                  (\n<em>)             // any lines skipped = $3 attacklab: lookbehind removed<br />                  ["(]<br />                  (.+?)             // title = $4<br />                  [")]<br />                  [ \t]</em><br />                )?                  // title is optional<br />                (?:\n+|$)<br />              /gm,<br />              function(){...});</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*&lt;?(\S+?)&gt;?[ \t]*\n?[ \t]*(?:(\n*)[&quot;(](.+?)[&quot;)][ \t]*)?(?:\n+|\Z)/gm</span><span class="p">,</span>
    <span class="kd">function</span> <span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">m1</span><span class="p">,</span><span class="nx">m2</span><span class="p">,</span><span class="nx">m3</span><span class="p">,</span><span class="nx">m4</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">m1</span> <span class="o">=</span> <span class="nx">m1</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
      <span class="nx">g_urls</span><span class="p">[</span><span class="nx">m1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_EncodeAmpsAndAngles</span><span class="p">(</span><span class="nx">m2</span><span class="p">);</span>  <span class="c1">// Link IDs are case-insensitive</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">m3</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-37"><td class="docs"><div class="pilwrap"><a href="#section-37" class="pilcrow">&#182;</a></div><p>Oops, found blank lines, so it's not a title.
Put back the parenthetical statement we stole.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">return</span> <span class="nx">m3</span><span class="o">+</span><span class="nx">m4</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">m4</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">g_titles</span><span class="p">[</span><span class="nx">m1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">m4</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&quot;/g</span><span class="p">,</span><span class="s2">&quot;&amp;quot;&quot;</span><span class="p">);</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-38"><td class="docs"><div class="pilwrap"><a href="#section-38" class="pilcrow">&#182;</a></div><p>Completely remove the definition from the text</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">);</span>

  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">_HashHTMLBlocks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-39"><td class="docs"><div class="pilwrap"><a href="#section-39" class="pilcrow">&#182;</a></div><p>attacklab: Double up blank lines to reduce lookaround</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n/g</span><span class="p">,</span><span class="s2">&quot;\n\n&quot;</span><span class="p">);</span></pre></div></td></tr><tr id="section-40"><td class="docs"><div class="pilwrap"><a href="#section-40" class="pilcrow">&#182;</a></div><p>Hashify HTML blocks:
We only want to do this for block-level HTML tags, such as headers,
lists, and tables. That's because we still want to wrap <p>s around
"paragraphs" that are wrapped in non-block-level tags, such as anchors,
phrase emphasis, and spans. The list of tags we're looking for is
hard-coded:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">block_tags_a</span> <span class="o">=</span> <span class="s2">&quot;p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del&quot;</span>
  <span class="kd">var</span> <span class="nx">block_tags_b</span> <span class="o">=</span> <span class="s2">&quot;p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math&quot;</span></pre></div></td></tr><tr id="section-41"><td class="docs"><div class="pilwrap"><a href="#section-41" class="pilcrow">&#182;</a></div><p>First, look for nested blocks, e.g.:
  <div>
    <div>
    tags for inner block must be indented.
    </div>
  </div></p>

<p>The outermost tags must start at the left margin for this to match, and
the inner nested divs must be indented.
We need to do this before the next, more liberal match, because the next
match will start at the first <code>&lt;div&gt;</code> and stop at the first <code>&lt;/div&gt;</code>.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-42"><td class="docs"><div class="pilwrap"><a href="#section-42" class="pilcrow">&#182;</a></div><p>attacklab: This regex can be expensive when it fails.</p>

<div class="dox"><div class="summary"><p>var text = text.replace(/<br />        (                       // save in $1<br />            ^                   // start of line  (with /m)<br />            &lt;($block_tags_a)   // start tag = $2<br />            \b                  // word break<br />                                // attacklab: hack around khtml/pcre bug...<br />            [^\r]<em>?\n           // any number of lines, minimally matching<br />            </\2>               // the matching end tag<br />            [ \t]</em>              // trailing spaces/tabs<br />            (?=\n+)             // followed by a newline<br />        )                       // attacklab: there are sentinel newlines at end of document<br />        /gm,function(){...}};</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^(&lt;(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b[^\r]*?\n&lt;\/\2&gt;[ \t]*(?=\n+))/gm</span><span class="p">,</span><span class="nx">hashElement</span><span class="p">);</span></pre></div></td></tr><tr id="section-43"><td class="docs"><div class="pilwrap"><a href="#section-43" class="pilcrow">&#182;</a></div><p>Now match more liberally, simply from <code>\n&lt;tag&gt;</code> to <code>&lt;/tag&gt;\n</code></p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-44"><td class="docs"><div class="pilwrap"><a href="#section-44" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>var text = text.replace(/<br />        (                       // save in $1<br />            ^                   // start of line  (with /m)<br />            &lt;($block_tags_b)   // start tag = $2<br />            \b                  // word break<br />                                // attacklab: hack around khtml/pcre bug...<br />            [^\r]<em>?             // any number of lines, minimally matching<br />            .</em></\2>             // the matching end tag<br />            [ \t]*              // trailing spaces/tabs<br />            (?=\n+)             // followed by a newline<br />        )                       // attacklab: there are sentinel newlines at end of document<br />        /gm,function(){...}};</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^(&lt;(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math)\b[^\r]*?.*&lt;\/\2&gt;[ \t]*(?=\n+)\n)/gm</span><span class="p">,</span><span class="nx">hashElement</span><span class="p">);</span></pre></div></td></tr><tr id="section-45"><td class="docs"><div class="pilwrap"><a href="#section-45" class="pilcrow">&#182;</a></div><p>Special case just for <hr />. It was easier to make a special case than
to make the other regex more complicated.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-46"><td class="docs"><div class="pilwrap"><a href="#section-46" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>text = text.replace(/<br />        (                       // save in $1<br />            \n\n                // Starting after a blank line<br />            [ ]{0,3}<br />            (&lt;(hr)              // start tag = $2<br />            \b                  // word break<br />            ([^&lt;>])<em>?           //<br />            \/?>)               // the matching end tag<br />            [ \t]</em><br />            (?=\n{2,})          // followed by a blank line<br />        )<br />        /g,hashElement);</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\n[ ]{0,3}(&lt;(hr)\b([^&lt;&gt;])*?\/?&gt;)[ \t]*(?=\n{2,}))/g</span><span class="p">,</span><span class="nx">hashElement</span><span class="p">);</span></pre></div></td></tr><tr id="section-47"><td class="docs"><div class="pilwrap"><a href="#section-47" class="pilcrow">&#182;</a></div><p>Special case for standalone HTML comments:</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-48"><td class="docs"><div class="pilwrap"><a href="#section-48" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>text = text.replace(/<br />        (                       // save in $1<br />            \n\n                // Starting after a blank line<br />            [ ]{0,3}            // attacklab: g_tab_width - 1<br />            <!<br />            (--[^\r]*?--\s*)+<br />            ><br />            [ \t]*<br />            (?=\n{2,})          // followed by a blank line<br />        )<br />        /g,hashElement);</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\n\n[ ]{0,3}&lt;!(--[^\r]*?--\s*)+&gt;[ \t]*(?=\n{2,}))/g</span><span class="p">,</span><span class="nx">hashElement</span><span class="p">);</span></pre></div></td></tr><tr id="section-49"><td class="docs"><div class="pilwrap"><a href="#section-49" class="pilcrow">&#182;</a></div><p>PHP and ASP-style processor instructions (<?...?> and &lt;%...%>)</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-50"><td class="docs"><div class="pilwrap"><a href="#section-50" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>text = text.replace(/<br />        (?:<br />            \n\n                // Starting after a blank line<br />        )<br />        (                       // save in $1<br />            [ ]{0,3}            // attacklab: g_tab_width - 1<br />            (?:<br />                &lt;([?%])         // $2<br />                [^\r]<em>?<br />                \2><br />            )<br />            [ \t]</em><br />            (?=\n{2,})          // followed by a blank line<br />        )<br />        /g,hashElement);</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(?:\n\n)([ ]{0,3}(?:&lt;([?%])[^\r]*?\2&gt;)[ \t]*(?=\n{2,}))/g</span><span class="p">,</span><span class="nx">hashElement</span><span class="p">);</span></pre></div></td></tr><tr id="section-51"><td class="docs"><div class="pilwrap"><a href="#section-51" class="pilcrow">&#182;</a></div><p>attacklab: Undo double lines (see comment at top of this function)</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n\n/g</span><span class="p">,</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">hashElement</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">m1</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">blockText</span> <span class="o">=</span> <span class="nx">m1</span><span class="p">;</span></pre></div></td></tr><tr id="section-52"><td class="docs"><div class="pilwrap"><a href="#section-52" class="pilcrow">&#182;</a></div><p>Undo double lines</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">blockText</span> <span class="o">=</span> <span class="nx">blockText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n\n/g</span><span class="p">,</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
  <span class="nx">blockText</span> <span class="o">=</span> <span class="nx">blockText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\n/</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span></pre></div></td></tr><tr id="section-53"><td class="docs"><div class="pilwrap"><a href="#section-53" class="pilcrow">&#182;</a></div><p>strip trailing blank lines</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">blockText</span> <span class="o">=</span> <span class="nx">blockText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n+$/g</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span></pre></div></td></tr><tr id="section-54"><td class="docs"><div class="pilwrap"><a href="#section-54" class="pilcrow">&#182;</a></div><p>Replace the element text with a marker ("~KxK" where x is its key)</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">blockText</span> <span class="o">=</span> <span class="s2">&quot;\n\n~K&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">g_html_blocks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">blockText</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;K\n\n&quot;</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">blockText</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">_RunBlockGamut</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-55"><td class="docs"><div class="pilwrap"><a href="#section-55" class="pilcrow">&#182;</a></div><p>These are all the transformations that form block-level
tags like paragraphs, headers, and list items.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_DoHeaders</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span></pre></div></td></tr><tr id="section-56"><td class="docs"><div class="pilwrap"><a href="#section-56" class="pilcrow">&#182;</a></div><p>Do Horizontal Rules:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">hashBlock</span><span class="p">(</span><span class="s2">&quot;&lt;hr /&gt;&quot;</span><span class="p">);</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$/gm</span><span class="p">,</span><span class="nx">key</span><span class="p">);</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^[ ]{0,2}([ ]?\-[ ]?){3,}[ \t]*$/gm</span><span class="p">,</span><span class="nx">key</span><span class="p">);</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^[ ]{0,2}([ ]?\_[ ]?){3,}[ \t]*$/gm</span><span class="p">,</span><span class="nx">key</span><span class="p">);</span>

  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_DoLists</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_DoCodeFencing</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_DoCodeBlocks</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_DoBlockQuotes</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span></pre></div></td></tr><tr id="section-57"><td class="docs"><div class="pilwrap"><a href="#section-57" class="pilcrow">&#182;</a></div><p>We already ran _HashHTMLBlocks() before, in Markdown(), but that
was to escape raw HTML in the original Markdown source. This time,
we're escaping the markup we've just created, so that we don't wrap
<p> tags around block-level tags.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_HashHTMLBlocks</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_FormParagraphs</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">_RunSpanGamut</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-58"><td class="docs"><div class="pilwrap"><a href="#section-58" class="pilcrow">&#182;</a></div><p>These are all the transformations that occur <em>within</em> block-level
tags like paragraphs, headers, and list items.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_DoCodeSpans</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_EscapeSpecialCharsWithinTagAttributes</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_EncodeBackslashEscapes</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span></pre></div></td></tr><tr id="section-59"><td class="docs"><div class="pilwrap"><a href="#section-59" class="pilcrow">&#182;</a></div><p>Process anchor and image tags. Images must come first,
because ![foo][f] looks like an anchor.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_DoImages</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_DoAnchors</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span></pre></div></td></tr><tr id="section-60"><td class="docs"><div class="pilwrap"><a href="#section-60" class="pilcrow">&#182;</a></div><p>Make links out of things like <code>&lt;http://example.com/&gt;</code>
Must come after _DoAnchors(), because you can use &lt; and >
delimiters in inline links like <a href="url">this</a>.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_DoAutoLinks</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_EncodeAmpsAndAngles</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">_DoItalicsAndBold</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span></pre></div></td></tr><tr id="section-61"><td class="docs"><div class="pilwrap"><a href="#section-61" class="pilcrow">&#182;</a></div><p>Do hard breaks:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/  +\n/g</span><span class="p">,</span><span class="s2">&quot; &lt;br /&gt;\n&quot;</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">_EscapeSpecialCharsWithinTagAttributes</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-62"><td class="docs"><div class="pilwrap"><a href="#section-62" class="pilcrow">&#182;</a></div><p>Within tags -- meaning between &lt; and > -- encode [\ ` * _] so they
don't conflict with their use in Markdown for code, italics and strong.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-63"><td class="docs"><div class="pilwrap"><a href="#section-63" class="pilcrow">&#182;</a></div><p>Build a regex to find HTML tags and comments.  See Friedl's
"Mastering Regular Expressions", 2nd Ed., pp. 200-201.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">regex</span> <span class="o">=</span> <span class="sr">/(&lt;[a-z\/!$](&quot;[^&quot;]*&quot;|&#39;[^&#39;]*&#39;|[^&#39;&quot;&gt;])*&gt;|&lt;!(--.*?--\s*)+&gt;)/gi</span><span class="p">;</span>

  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">regex</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tag</span> <span class="o">=</span> <span class="nx">wholeMatch</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(.)&lt;\/?code&gt;(?=.)/g</span><span class="p">,</span><span class="s2">&quot;$1`&quot;</span><span class="p">);</span>
    <span class="nx">tag</span> <span class="o">=</span> <span class="nx">escapeCharacters</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span><span class="s2">&quot;\\`*_&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">tag</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">_DoAnchors</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-64"><td class="docs"><div class="pilwrap"><a href="#section-64" class="pilcrow">&#182;</a></div><p>Turn Markdown link shortcuts into XHTML <a> tags.</p>

<p>First, handle reference-style links: [link text] [id]</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-65"><td class="docs"><div class="pilwrap"><a href="#section-65" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>text = text.replace(/<br />        (                           // wrap whole match in $1<br />            [<br />            (<br />                (?:<br />                    [[^]]<em>]      // allow brackets nested one level<br />                    |<br />                    [^[]           // or anything else<br />                )</em><br />            )<br />            ]</p></div><div class="body"><pre><code>        [ ]?                    // one optional space
        (?:\n[ ]*)?             // one optional newline followed by spaces

        \[
        (.*?)                   // id = $3
        \]
    )()()()()                   // pad remaining backreferences
    /g,_DoAnchors_callback);
</code></pre></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\[((?:\[[^\]]*\]|[^\[\]])*)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g</span><span class="p">,</span><span class="nx">writeAnchorTag</span><span class="p">);</span></pre></div></td></tr><tr id="section-66"><td class="docs"><div class="pilwrap"><a href="#section-66" class="pilcrow">&#182;</a></div><p>Next, inline-style links: <a href="url" title="optional title">link text</a></p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-67"><td class="docs"><div class="pilwrap"><a href="#section-67" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>text = text.replace(/<br />            (                       // wrap whole match in $1<br />                [<br />                (<br />                    (?:<br />                        [[^]]<em>]  // allow brackets nested one level<br />                    |<br />                    [^[]]         // or anything else<br />                )<br />            )<br />            ]<br />            (                      // literal paren<br />            [ \t]</em><br />            ()                      // no id, so leave $3 empty<br />            <?(.<em>?)>?               // href = $4<br />            [ \t]</em><br />            (                       // $5<br />                (['"])              // quote char = $6<br />                (.<em>?)               // Title = $7<br />                \6                  // matching quote<br />                [ \t]</em>              // ignore any spaces/tabs between closing quote and )<br />            )?                      // title is optional<br />            )<br />        )<br />        /g,writeAnchorTag);</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\[((?:\[[^\]]*\]|[^\[\]])*)\]\([ \t]*()&lt;?(.*?)&gt;?[ \t]*(([&#39;&quot;])(.*?)\6[ \t]*)?\))/g</span><span class="p">,</span><span class="nx">writeAnchorTag</span><span class="p">);</span></pre></div></td></tr><tr id="section-68"><td class="docs"><div class="pilwrap"><a href="#section-68" class="pilcrow">&#182;</a></div><p>Last, handle reference-style shortcuts: [link text]
These must come last in case you've also got [link test][1]
or <a href="/foo">link test</a></p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-69"><td class="docs"><div class="pilwrap"><a href="#section-69" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>text = text.replace(/<br />        (                           // wrap whole match in $1<br />            [<br />            ([^[]]+)              // link text = $2; can't contain '[' or ']'<br />            ]<br />        )()()()()()                 // pad rest of backreferences<br />        /g, writeAnchorTag);</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\[([^\[\]]+)\])()()()()()/g</span><span class="p">,</span> <span class="nx">writeAnchorTag</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">writeAnchorTag</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">m1</span><span class="p">,</span><span class="nx">m2</span><span class="p">,</span><span class="nx">m3</span><span class="p">,</span><span class="nx">m4</span><span class="p">,</span><span class="nx">m5</span><span class="p">,</span><span class="nx">m6</span><span class="p">,</span><span class="nx">m7</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">m7</span> <span class="o">==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">m7</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">whole_match</span> <span class="o">=</span> <span class="nx">m1</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">link_text</span>   <span class="o">=</span> <span class="nx">m2</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">link_id</span>  <span class="o">=</span> <span class="nx">m3</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">url</span>   <span class="o">=</span> <span class="nx">m4</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">m7</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">url</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">link_id</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-70"><td class="docs"><div class="pilwrap"><a href="#section-70" class="pilcrow">&#182;</a></div><p>lower-case and turn embedded newlines into spaces</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">link_id</span> <span class="o">=</span> <span class="nx">link_text</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/ ?\n/g</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">url</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span><span class="o">+</span><span class="nx">link_id</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">g_urls</span><span class="p">[</span><span class="nx">link_id</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">url</span> <span class="o">=</span> <span class="nx">g_urls</span><span class="p">[</span><span class="nx">link_id</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">g_titles</span><span class="p">[</span><span class="nx">link_id</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">title</span> <span class="o">=</span> <span class="nx">g_titles</span><span class="p">[</span><span class="nx">link_id</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">whole_match</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/\(\s*\)$/m</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-71"><td class="docs"><div class="pilwrap"><a href="#section-71" class="pilcrow">&#182;</a></div><p>Special case for explicit empty url</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">url</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">whole_match</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">url</span> <span class="o">=</span> <span class="nx">escapeCharacters</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="s2">&quot;*_&quot;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="s2">&quot;&lt;a href=\&quot;&quot;</span> <span class="o">+</span> <span class="nx">url</span> <span class="o">+</span> <span class="s2">&quot;\&quot;&quot;</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">title</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">title</span> <span class="o">=</span> <span class="nx">title</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&quot;/g</span><span class="p">,</span><span class="s2">&quot;&amp;quot;&quot;</span><span class="p">);</span>
    <span class="nx">title</span> <span class="o">=</span> <span class="nx">escapeCharacters</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="s2">&quot;*_&quot;</span><span class="p">);</span>
    <span class="nx">result</span> <span class="o">+=</span>  <span class="s2">&quot; title=\&quot;&quot;</span> <span class="o">+</span> <span class="nx">title</span> <span class="o">+</span> <span class="s2">&quot;\&quot;&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">result</span> <span class="o">+=</span> <span class="s2">&quot;&gt;&quot;</span> <span class="o">+</span> <span class="nx">link_text</span> <span class="o">+</span> <span class="s2">&quot;&lt;/a&gt;&quot;</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">_DoImages</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-72"><td class="docs"><div class="pilwrap"><a href="#section-72" class="pilcrow">&#182;</a></div><p>Turn Markdown image shortcuts into <img> tags.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-73"><td class="docs"><div class="pilwrap"><a href="#section-73" class="pilcrow">&#182;</a></div><p>First, handle reference-style labeled images: ![alt text][id]</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-74"><td class="docs"><div class="pilwrap"><a href="#section-74" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>text = text.replace(/<br />        (                       // wrap whole match in $1<br />            ![<br />            (.*?)               // alt text = $2<br />            ]</p></div><div class="body"><pre><code>        [ ]?                // one optional space
        (?:\n[ ]*)?         // one optional newline followed by spaces

        \[
        (.*?)               // id = $3
        \]
    )()()()()               // pad rest of backreferences
    /g,writeImageTag);
</code></pre></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g</span><span class="p">,</span><span class="nx">writeImageTag</span><span class="p">);</span></pre></div></td></tr><tr id="section-75"><td class="docs"><div class="pilwrap"><a href="#section-75" class="pilcrow">&#182;</a></div><p>Next, handle inline images:  <img src="url" alt="alt text" title="optional title" />
Don't forget: encode * and _</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-76"><td class="docs"><div class="pilwrap"><a href="#section-76" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>text = text.replace(/<br />        (                       // wrap whole match in $1<br />            ![<br />            (.<em>?)               // alt text = $2<br />            ]<br />            \s?                 // One optional whitespace character<br />            (                  // literal paren<br />            [ \t]</em><br />            ()                  // no id, so leave $3 empty<br />            <?(\S+?)>?          // src url = $4<br />            [ \t]*<br />            (                   // $5<br />                (['"])          // quote char = $6<br />                (.<em>?)           // title = $7<br />                \6              // matching quote<br />                [ \t]</em><br />            )?                  // title is optional<br />        )<br />        )<br />        /g,writeImageTag);</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(!\[(.*?)\]\s?\([ \t]*()&lt;?(\S+?)&gt;?[ \t]*(([&#39;&quot;])(.*?)\6[ \t]*)?\))/g</span><span class="p">,</span><span class="nx">writeImageTag</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">writeImageTag</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">m1</span><span class="p">,</span><span class="nx">m2</span><span class="p">,</span><span class="nx">m3</span><span class="p">,</span><span class="nx">m4</span><span class="p">,</span><span class="nx">m5</span><span class="p">,</span><span class="nx">m6</span><span class="p">,</span><span class="nx">m7</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">whole_match</span> <span class="o">=</span> <span class="nx">m1</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">alt_text</span>   <span class="o">=</span> <span class="nx">m2</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">link_id</span>  <span class="o">=</span> <span class="nx">m3</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">url</span>   <span class="o">=</span> <span class="nx">m4</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">m7</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">title</span><span class="p">)</span> <span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">url</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">link_id</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-77"><td class="docs"><div class="pilwrap"><a href="#section-77" class="pilcrow">&#182;</a></div><p>lower-case and turn embedded newlines into spaces</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">link_id</span> <span class="o">=</span> <span class="nx">alt_text</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/ ?\n/g</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">url</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span><span class="o">+</span><span class="nx">link_id</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">g_urls</span><span class="p">[</span><span class="nx">link_id</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">url</span> <span class="o">=</span> <span class="nx">g_urls</span><span class="p">[</span><span class="nx">link_id</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">g_titles</span><span class="p">[</span><span class="nx">link_id</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">title</span> <span class="o">=</span> <span class="nx">g_titles</span><span class="p">[</span><span class="nx">link_id</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">whole_match</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">alt_text</span> <span class="o">=</span> <span class="nx">alt_text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&quot;/g</span><span class="p">,</span><span class="s2">&quot;&amp;quot;&quot;</span><span class="p">);</span>
  <span class="nx">url</span> <span class="o">=</span> <span class="nx">escapeCharacters</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="s2">&quot;*_&quot;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="s2">&quot;&lt;img src=\&quot;&quot;</span> <span class="o">+</span> <span class="nx">url</span> <span class="o">+</span> <span class="s2">&quot;\&quot; alt=\&quot;&quot;</span> <span class="o">+</span> <span class="nx">alt_text</span> <span class="o">+</span> <span class="s2">&quot;\&quot;&quot;</span><span class="p">;</span></pre></div></td></tr><tr id="section-78"><td class="docs"><div class="pilwrap"><a href="#section-78" class="pilcrow">&#182;</a></div><p>attacklab: Markdown.pl adds empty title attributes to images.
Replicate this bug.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-79"><td class="docs"><div class="pilwrap"><a href="#section-79" class="pilcrow">&#182;</a></div><p>if (title != "") {</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">title</span> <span class="o">=</span> <span class="nx">title</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&quot;/g</span><span class="p">,</span><span class="s2">&quot;&amp;quot;&quot;</span><span class="p">);</span>
    <span class="nx">title</span> <span class="o">=</span> <span class="nx">escapeCharacters</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="s2">&quot;*_&quot;</span><span class="p">);</span>
    <span class="nx">result</span> <span class="o">+=</span>  <span class="s2">&quot; title=\&quot;&quot;</span> <span class="o">+</span> <span class="nx">title</span> <span class="o">+</span> <span class="s2">&quot;\&quot;&quot;</span><span class="p">;</span></pre></div></td></tr><tr id="section-80"><td class="docs"><div class="pilwrap"><a href="#section-80" class="pilcrow">&#182;</a></div><p>}</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">result</span> <span class="o">+=</span> <span class="s2">&quot; /&gt;&quot;</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">_DoHeaders</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-81"><td class="docs"><div class="pilwrap"><a href="#section-81" class="pilcrow">&#182;</a></div><p>Setext-style headers:</p>

<h1>Header 1</h1>

<h2>Header 2</h2>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^(.+)[ \t]*\n=+[ \t]*\n+/gm</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">m1</span><span class="p">){</span><span class="k">return</span> <span class="nx">hashBlock</span><span class="p">(</span><span class="s2">&quot;&lt;h1&gt;&quot;</span> <span class="o">+</span> <span class="nx">_RunSpanGamut</span><span class="p">(</span><span class="nx">m1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&lt;/h1&gt;&quot;</span><span class="p">);});</span>

  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^(.+)[ \t]*\n-+[ \t]*\n+/gm</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">matchFound</span><span class="p">,</span><span class="nx">m1</span><span class="p">){</span><span class="k">return</span> <span class="nx">hashBlock</span><span class="p">(</span><span class="s2">&quot;&lt;h2&gt;&quot;</span> <span class="o">+</span> <span class="nx">_RunSpanGamut</span><span class="p">(</span><span class="nx">m1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&lt;/h2&gt;&quot;</span><span class="p">);});</span></pre></div></td></tr><tr id="section-82"><td class="docs"><div class="pilwrap"><a href="#section-82" class="pilcrow">&#182;</a></div><p>atx-style headers:
 # Header 1
 ## Header 2
 ## Header 2 with closing hashes ##
 ...
 ###### Header 6</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-83"><td class="docs"><div class="pilwrap"><a href="#section-83" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>text = text.replace(/<br />            ^(#{1,6})              // $1 = string of #'s<br />            [ \t]*<br />            (.+?)                   // $2 = Header text<br />            [ \t]*<br />            #*                     // optional closing #'s (not counted)<br />            \n+<br />        /gm, function() {...});</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^(\#{1,6})[ \t]*(.+?)[ \t]*\#*\n+/gm</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">m1</span><span class="p">,</span><span class="nx">m2</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">h_level</span> <span class="o">=</span> <span class="nx">m1</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">hashBlock</span><span class="p">(</span><span class="s2">&quot;&lt;h&quot;</span> <span class="o">+</span> <span class="nx">h_level</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span> <span class="o">+</span> <span class="nx">_RunSpanGamut</span><span class="p">(</span><span class="nx">m2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&lt;/h&quot;</span> <span class="o">+</span> <span class="nx">h_level</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">);</span>
    <span class="p">});</span>

  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-84"><td class="docs"><div class="pilwrap"><a href="#section-84" class="pilcrow">&#182;</a></div><p>This declaration keeps Dojo compressor from outputting garbage:</p>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">_ProcessListItems</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">_DoLists</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-85"><td class="docs"><div class="pilwrap"><a href="#section-85" class="pilcrow">&#182;</a></div><p>Form HTML ordered (numbered) and unordered (bulleted) lists.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-86"><td class="docs"><div class="pilwrap"><a href="#section-86" class="pilcrow">&#182;</a></div><p>attacklab: add sentinel to hack around khtml/safari bug:
http://bugs.webkit.org/show_bug.cgi?id=11231</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">+=</span> <span class="s2">&quot;~0&quot;</span><span class="p">;</span></pre></div></td></tr><tr id="section-87"><td class="docs"><div class="pilwrap"><a href="#section-87" class="pilcrow">&#182;</a></div><p>Re-usable pattern to match any entirel ul or ol list:</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-88"><td class="docs"><div class="pilwrap"><a href="#section-88" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>var whole_list = /<br />        (                                   // $1 = whole list<br />            (                               // $2<br />                [ ]{0,3}                    // attacklab: g_tab_width - 1<br />                ([<em>+-]|\d+[.])              // $3 = first list item marker<br />                [ \t]+<br />            )<br />            [^\r]+?<br />            (                               // $4<br />                ~0                         // sentinel for workaround; should be $<br />            |<br />                \n{2,}<br />                (?=\S)<br />                (?!                         // Negative lookahead for another list item marker<br />                    [ \t]</em><br />                    (?:[*+-]|\d+[.])[ \t]+<br />                )<br />            )<br />        )/g</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">whole_list</span> <span class="o">=</span> <span class="sr">/^(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">g_list_level</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">whole_list</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">m1</span><span class="p">,</span><span class="nx">m2</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">m1</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">list_type</span> <span class="o">=</span> <span class="p">(</span><span class="nx">m2</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/[*+-]/g</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;ul&quot;</span> <span class="o">:</span> <span class="s2">&quot;ol&quot;</span><span class="p">;</span></pre></div></td></tr><tr id="section-89"><td class="docs"><div class="pilwrap"><a href="#section-89" class="pilcrow">&#182;</a></div><p>Turn double returns into triple returns, so that we can make a
paragraph for the last item in a list, if necessary:</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">list</span> <span class="o">=</span> <span class="nx">list</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n{2,}/g</span><span class="p">,</span><span class="s2">&quot;\n\n\n&quot;</span><span class="p">);;</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">_ProcessListItems</span><span class="p">(</span><span class="nx">list</span><span class="p">);</span></pre></div></td></tr><tr id="section-90"><td class="docs"><div class="pilwrap"><a href="#section-90" class="pilcrow">&#182;</a></div><p>Trim any trailing whitespace, to put the closing <code>&lt;/$list_type&gt;</code>
up on the preceding line, to get it past the current stupid
HTML block parser. This is a hack to work around the terrible
hack that is the HTML block parser.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+$/</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="s2">&quot;&lt;&quot;</span><span class="o">+</span><span class="nx">list_type</span><span class="o">+</span><span class="s2">&quot;&gt;&quot;</span> <span class="o">+</span> <span class="nx">result</span> <span class="o">+</span> <span class="s2">&quot;&lt;/&quot;</span><span class="o">+</span><span class="nx">list_type</span><span class="o">+</span><span class="s2">&quot;&gt;\n&quot;</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">whole_list</span> <span class="o">=</span> <span class="sr">/(\n\n|^\n?)(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/g</span><span class="p">;</span>
    <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">whole_list</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">m1</span><span class="p">,</span><span class="nx">m2</span><span class="p">,</span><span class="nx">m3</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">runup</span> <span class="o">=</span> <span class="nx">m1</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">m2</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">list_type</span> <span class="o">=</span> <span class="p">(</span><span class="nx">m3</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/[*+-]/g</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;ul&quot;</span> <span class="o">:</span> <span class="s2">&quot;ol&quot;</span><span class="p">;</span></pre></div></td></tr><tr id="section-91"><td class="docs"><div class="pilwrap"><a href="#section-91" class="pilcrow">&#182;</a></div><p>Turn double returns into triple returns, so that we can make a
paragraph for the last item in a list, if necessary:</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">list</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n{2,}/g</span><span class="p">,</span><span class="s2">&quot;\n\n\n&quot;</span><span class="p">);;</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">_ProcessListItems</span><span class="p">(</span><span class="nx">list</span><span class="p">);</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">runup</span> <span class="o">+</span> <span class="s2">&quot;&lt;&quot;</span><span class="o">+</span><span class="nx">list_type</span><span class="o">+</span><span class="s2">&quot;&gt;\n&quot;</span> <span class="o">+</span> <span class="nx">result</span> <span class="o">+</span> <span class="s2">&quot;&lt;/&quot;</span><span class="o">+</span><span class="nx">list_type</span><span class="o">+</span><span class="s2">&quot;&gt;\n&quot;</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-92"><td class="docs"><div class="pilwrap"><a href="#section-92" class="pilcrow">&#182;</a></div><p>attacklab: strip sentinel</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/~0/</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">_ProcessListItems</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">list_str</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-93"><td class="docs"><div class="pilwrap"><a href="#section-93" class="pilcrow">&#182;</a></div><p>Process the contents of a single ordered or unordered list, splitting it
 into individual list items.</p>

<p>The $g<em>list</em>level global keeps track of when we're inside a list.
Each time we enter a list, we increment it; when we leave a list,
we decrement. If it's zero, we're not in a list anymore.</p>

<p>We do this because when we're not inside a list, we want to treat
something like this:</p>

<p>I recommend upgrading to version
   8. Oops, now this line is treated
   as a sub-list.</p>

<p>As a single paragraph, despite the fact that the second line starts
with a digit-period-space sequence.</p>

<p>Whereas when we're inside a list (or sub-list), that line will be
treated as the start of a sub-list. What a kludge, huh? This is
an aspect of Markdown's syntax that's hard to parse perfectly
without resorting to mind-reading. Perhaps the solution is to
change the syntax rules such that sub-lists must start with a
starting cardinal number; e.g. "1." or "a.".</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">g_list_level</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr><tr id="section-94"><td class="docs"><div class="pilwrap"><a href="#section-94" class="pilcrow">&#182;</a></div><p>trim trailing blank lines:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">list_str</span> <span class="o">=</span> <span class="nx">list_str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n{2,}$/</span><span class="p">,</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span></pre></div></td></tr><tr id="section-95"><td class="docs"><div class="pilwrap"><a href="#section-95" class="pilcrow">&#182;</a></div><p>attacklab: add sentinel to emulate \z</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">list_str</span> <span class="o">+=</span> <span class="s2">&quot;~0&quot;</span><span class="p">;</span></pre></div></td></tr><tr id="section-96"><td class="docs"><div class="pilwrap"><a href="#section-96" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>list_str = list_str.replace(/<br />            (\n)?                           // leading line = $1<br />            (^[ \t]<em>)                       // leading whitespace = $2<br />            ([</em>+-]|\d+[.]) [ \t]+           // list marker = $3<br />            ([^\r]+?                        // list item text   = $4<br />            (\n{1,2}))<br />            (?= \n* (~0 | \2 ([*+-]|\d+[.]) [ \t]+))<br />        /gm, function(){...});</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">list_str</span> <span class="o">=</span> <span class="nx">list_str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\n)?(^[ \t]*)([*+-]|\d+[.])[ \t]+([^\r]+?(\n{1,2}))(?=\n*(~0|\2([*+-]|\d+[.])[ \t]+))/gm</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">m1</span><span class="p">,</span><span class="nx">m2</span><span class="p">,</span><span class="nx">m3</span><span class="p">,</span><span class="nx">m4</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">m4</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">leading_line</span> <span class="o">=</span> <span class="nx">m1</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">leading_space</span> <span class="o">=</span> <span class="nx">m2</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">leading_line</span> <span class="o">||</span> <span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/\n{2,}/</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">item</span> <span class="o">=</span> <span class="nx">_RunBlockGamut</span><span class="p">(</span><span class="nx">_Outdent</span><span class="p">(</span><span class="nx">item</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-97"><td class="docs"><div class="pilwrap"><a href="#section-97" class="pilcrow">&#182;</a></div><p>Recursion for sub-lists:</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">item</span> <span class="o">=</span> <span class="nx">_DoLists</span><span class="p">(</span><span class="nx">_Outdent</span><span class="p">(</span><span class="nx">item</span><span class="p">));</span>
        <span class="nx">item</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n$/</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="c1">// chomp(item)</span>
        <span class="nx">item</span> <span class="o">=</span> <span class="nx">_RunSpanGamut</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span>  <span class="s2">&quot;&lt;li&gt;&quot;</span> <span class="o">+</span> <span class="nx">item</span> <span class="o">+</span> <span class="s2">&quot;&lt;/li&gt;\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">);</span></pre></div></td></tr><tr id="section-98"><td class="docs"><div class="pilwrap"><a href="#section-98" class="pilcrow">&#182;</a></div><p>attacklab: strip sentinel</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">list_str</span> <span class="o">=</span> <span class="nx">list_str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/~0/g</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span>

  <span class="nx">g_list_level</span><span class="o">--</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">list_str</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">_DoCodeBlocks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-99"><td class="docs"><div class="pilwrap"><a href="#section-99" class="pilcrow">&#182;</a></div><p>Process Markdown <code>&lt;pre&gt;&lt;code&gt;</code> blocks.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-100"><td class="docs"><div class="pilwrap"><a href="#section-100" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>text = text.replace(text,<br />            /(?:\n\n|^)<br />            (                               // $1 = the code block -- one or more lines, starting with a space/tab<br />                (?:<br />                    (?:[ ]{4}|\t)           // Lines must start with a tab or a tab-width of spaces - attacklab: g_tab_width<br />                    .<em>\n+<br />                )+<br />            )<br />            (\n</em>[ ]{0,3}[^ \t\n]|(?=~0))   // attacklab: g_tab_width<br />        /g,function(){...});</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-101"><td class="docs"><div class="pilwrap"><a href="#section-101" class="pilcrow">&#182;</a></div><p>attacklab: sentinel workarounds for lack of \A and \Z, safari\khtml bug</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">+=</span> <span class="s2">&quot;~0&quot;</span><span class="p">;</span>

  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(?:\n\n|^)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=~0))/g</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">m1</span><span class="p">,</span><span class="nx">m2</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">codeblock</span> <span class="o">=</span> <span class="nx">m1</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">nextChar</span> <span class="o">=</span> <span class="nx">m2</span><span class="p">;</span>

      <span class="nx">codeblock</span> <span class="o">=</span> <span class="nx">_EncodeCode</span><span class="p">(</span> <span class="nx">_Outdent</span><span class="p">(</span><span class="nx">codeblock</span><span class="p">));</span>
      <span class="nx">codeblock</span> <span class="o">=</span> <span class="nx">_Detab</span><span class="p">(</span><span class="nx">codeblock</span><span class="p">);</span>
      <span class="nx">codeblock</span> <span class="o">=</span> <span class="nx">codeblock</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\n+/g</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="c1">// trim leading newlines</span>
      <span class="nx">codeblock</span> <span class="o">=</span> <span class="nx">codeblock</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n+$/g</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="c1">// trim trailing whitespace</span>

      <span class="nx">codeblock</span> <span class="o">=</span> <span class="s2">&quot;&lt;pre&gt;&lt;code&gt;&quot;</span> <span class="o">+</span> <span class="nx">codeblock</span> <span class="o">+</span> <span class="s2">&quot;\n&lt;/code&gt;&lt;/pre&gt;&quot;</span><span class="p">;</span>

      <span class="k">return</span> <span class="nx">hashBlock</span><span class="p">(</span><span class="nx">codeblock</span><span class="p">)</span> <span class="o">+</span> <span class="nx">nextChar</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">);</span></pre></div></td></tr><tr id="section-102"><td class="docs"><div class="pilwrap"><a href="#section-102" class="pilcrow">&#182;</a></div><p>attacklab: strip sentinel</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/~0/</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-103"><td class="docs"><div class="pilwrap"><a href="#section-103" class="pilcrow">&#182;</a></div><p>Code Fencing is a GitHub flavored MD concept. Basically you can wrap
your code like this:</p>

<p><code>{language}
{code}
</code></p>

<p>Where {language} is the language of the code (useful for coloring code)
and {code} is your code</p>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">_DoCodeFencing</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/`{3}(?:(.*$)\n)?([\s\S]*?)`{3}/gm</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">m1</span><span class="p">,</span><span class="nx">m2</span><span class="p">){</span></pre></div></td></tr><tr id="section-104"><td class="docs"><div class="pilwrap"><a href="#section-104" class="pilcrow">&#182;</a></div><p>HTML for this is copied from GitHub directly for compatibility, except the lang="" attribute</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">codeblock</span> <span class="o">=</span> <span class="s1">&#39;&lt;div class=&quot;highlight&quot;&gt;&lt;pre lang=&quot;&#39;</span><span class="o">+</span><span class="nx">m1</span><span class="o">+</span><span class="s1">&#39;&quot;&gt;&#39;</span><span class="o">+</span><span class="nx">m2</span><span class="o">+</span><span class="s1">&#39;&lt;/pre&gt;&lt;/div&gt;&#39;</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">codeblock</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">)</span>
  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">hashBlock</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(^\n+|\n+$)/g</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="s2">&quot;\n\n~K&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">g_html_blocks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;K\n\n&quot;</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">_DoCodeSpans</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-105"><td class="docs"><div class="pilwrap"><a href="#section-105" class="pilcrow">&#182;</a></div><ul>
<li><p>Backtick quotes are used for <code></code> spans.</p></li>
<li><p>You can use multiple backticks as the delimiters if you want to
include literal backticks in the code span. So, this input:</p>

<p>Just type <code>foo `bar` baz</code> at the prompt.</p>

<p>Will translate to:</p>

<p><p>Just type <code>foo <code>bar</code> baz</code> at the prompt.</p></p></li>
</ul>

<p>There's no arbitrary limit to the number of backticks you
can use as delimters. If you need three consecutive backticks
in your code, use four for delimiters, etc.</p>

<ul>
<li><p>You can use spaces to get literal backticks at the edges:</p>

<p>... type <code>`bar`</code> ...</p>

<p>Turns to:</p>

<p>... type <code><code>bar</code></code> ...</p></li>
</ul>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-106"><td class="docs"><div class="pilwrap"><a href="#section-106" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>text = text.replace(/<br />            (^|[^\])                   // Character before opening <code>can't be a backslash<br />            (</code>+)                        // $2 = Opening run of <code><br />            (                           // $3 = The code block<br />                [^\r]*?<br />                [^</code>]                    // attacklab: work around lack of lookbehind<br />            )<br />            \2                          // Matching closer<br />            (?!`)<br />        /gm, function(){...});</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">m1</span><span class="p">,</span><span class="nx">m2</span><span class="p">,</span><span class="nx">m3</span><span class="p">,</span><span class="nx">m4</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">m3</span><span class="p">;</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^([ \t]*)/g</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="c1">// leading whitespace</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[ \t]*$/g</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="c1">// trailing whitespace</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="nx">_EncodeCode</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">m1</span><span class="o">+</span><span class="s2">&quot;&lt;code&gt;&quot;</span><span class="o">+</span><span class="nx">c</span><span class="o">+</span><span class="s2">&quot;&lt;/code&gt;&quot;</span><span class="p">;</span>
    <span class="p">});</span>

  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">_EncodeCode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-107"><td class="docs"><div class="pilwrap"><a href="#section-107" class="pilcrow">&#182;</a></div><p>Encode/escape certain characters inside Markdown code runs.
The point is that in code, these characters are literals,
and lose their special Markdown meanings.</p>

<p>Encode all ampersands; HTML entities are not
entities within a Markdown code span.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;/g</span><span class="p">,</span><span class="s2">&quot;&amp;amp;&quot;</span><span class="p">);</span></pre></div></td></tr><tr id="section-108"><td class="docs"><div class="pilwrap"><a href="#section-108" class="pilcrow">&#182;</a></div><p>Do the angle bracket song and dance:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;/g</span><span class="p">,</span><span class="s2">&quot;&amp;lt;&quot;</span><span class="p">);</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&gt;/g</span><span class="p">,</span><span class="s2">&quot;&amp;gt;&quot;</span><span class="p">);</span></pre></div></td></tr><tr id="section-109"><td class="docs"><div class="pilwrap"><a href="#section-109" class="pilcrow">&#182;</a></div><p>Now, escape characters that are magic in Markdown:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">escapeCharacters</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="s2">&quot;\*_{}[]\\&quot;</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span></pre></div></td></tr><tr id="section-110"><td class="docs"><div class="pilwrap"><a href="#section-110" class="pilcrow">&#182;</a></div><h2>jj the line above breaks this:</h2>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-111"><td class="docs"><div class="pilwrap"><a href="#section-111" class="pilcrow">&#182;</a></div><ul>
<li>Item</li>
</ul>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-112"><td class="docs"><div class="pilwrap"><a href="#section-112" class="pilcrow">&#182;</a></div><ol>
<li>Subitem</li>
</ol>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-113"><td class="docs"><div class="pilwrap"><a href="#section-113" class="pilcrow">&#182;</a></div><h2>           special char: *</h2>
</td><td class="code"><div class="highlight"><pre>  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">_DoItalicsAndBold</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-114"><td class="docs"><div class="pilwrap"><a href="#section-114" class="pilcrow">&#182;</a></div><p><strong> must go first:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\*\*|__)(?=\S)([^\r]*?\S[*_]*)\1/g</span><span class="p">,</span>
    <span class="s2">&quot;&lt;strong&gt;$2&lt;/strong&gt;&quot;</span><span class="p">);</span>

  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\w)_(\w)/g</span><span class="p">,</span> <span class="s2">&quot;$1~E95E$2&quot;</span><span class="p">)</span> <span class="c1">// ** GFM **  &quot;~E95E&quot; == escaped &quot;_&quot;</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\*|_)(?=\S)([^\r]*?\S)\1/g</span><span class="p">,</span>
    <span class="s2">&quot;&lt;em&gt;$2&lt;/em&gt;&quot;</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">_DoBlockQuotes</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-115"><td class="docs"><div class="pilwrap"><a href="#section-115" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>text = text.replace(/<br />        (                               // Wrap whole match in $1<br />            (<br />                ^[ \t]<em>>[ \t]?          // '>' at the start of a line<br />                .+\n                    // rest of the first line<br />                (.+\n)</em>                 // subsequent consecutive lines<br />                \n*                     // blanks<br />            )+<br />        )<br />        /gm, function(){...});</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/((^[ \t]*&gt;[ \t]?.+\n(.+\n)*\n*)+)/gm</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">m1</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">bq</span> <span class="o">=</span> <span class="nx">m1</span><span class="p">;</span></pre></div></td></tr><tr id="section-116"><td class="docs"><div class="pilwrap"><a href="#section-116" class="pilcrow">&#182;</a></div><p>attacklab: hack around Konqueror 3.5.4 bug:
"----------bug".replace(/^-/g,"") == "bug"</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">bq</span> <span class="o">=</span> <span class="nx">bq</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^[ \t]*&gt;[ \t]?/gm</span><span class="p">,</span><span class="s2">&quot;~0&quot;</span><span class="p">);</span> <span class="c1">// trim one level of quoting</span></pre></div></td></tr><tr id="section-117"><td class="docs"><div class="pilwrap"><a href="#section-117" class="pilcrow">&#182;</a></div><p>attacklab: clean up hack</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">bq</span> <span class="o">=</span> <span class="nx">bq</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/~0/g</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span>

      <span class="nx">bq</span> <span class="o">=</span> <span class="nx">bq</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^[ \t]+$/gm</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span>   <span class="c1">// trim whitespace-only lines</span>
      <span class="nx">bq</span> <span class="o">=</span> <span class="nx">_RunBlockGamut</span><span class="p">(</span><span class="nx">bq</span><span class="p">);</span>        <span class="c1">// recurse</span>

      <span class="nx">bq</span> <span class="o">=</span> <span class="nx">bq</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(^|\n)/g</span><span class="p">,</span><span class="s2">&quot;$1  &quot;</span><span class="p">);</span></pre></div></td></tr><tr id="section-118"><td class="docs"><div class="pilwrap"><a href="#section-118" class="pilcrow">&#182;</a></div><p>These leading spaces screw with <pre> content, so we need to fix that:</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">bq</span> <span class="o">=</span> <span class="nx">bq</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span>
          <span class="sr">/(\s*&lt;pre&gt;[^\r]+?&lt;\/pre&gt;)/gm</span><span class="p">,</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">m1</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">pre</span> <span class="o">=</span> <span class="nx">m1</span><span class="p">;</span></pre></div></td></tr><tr id="section-119"><td class="docs"><div class="pilwrap"><a href="#section-119" class="pilcrow">&#182;</a></div><p>attacklab: hack around Konqueror 3.5.4 bug:</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">pre</span> <span class="o">=</span> <span class="nx">pre</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^  /mg</span><span class="p">,</span><span class="s2">&quot;~0&quot;</span><span class="p">);</span>
          <span class="nx">pre</span> <span class="o">=</span> <span class="nx">pre</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/~0/g</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">pre</span><span class="p">;</span>
        <span class="p">});</span>

      <span class="k">return</span> <span class="nx">hashBlock</span><span class="p">(</span><span class="s2">&quot;&lt;blockquote&gt;\n&quot;</span> <span class="o">+</span> <span class="nx">bq</span> <span class="o">+</span> <span class="s2">&quot;\n&lt;/blockquote&gt;&quot;</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">_FormParagraphs</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-120"><td class="docs"><div class="pilwrap"><a href="#section-120" class="pilcrow">&#182;</a></div><p>Params:
   $text - string to process with html <p> tags</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-121"><td class="docs"><div class="pilwrap"><a href="#section-121" class="pilcrow">&#182;</a></div><p>Strip leading and trailing lines:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\n+/g</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n+$/g</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">grafs</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\n{2,}/g</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">grafsOut</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span></pre></div></td></tr><tr id="section-122"><td class="docs"><div class="pilwrap"><a href="#section-122" class="pilcrow">&#182;</a></div><p>Wrap <p> tags.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">grafs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">end</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="nx">grafs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span></pre></div></td></tr><tr id="section-123"><td class="docs"><div class="pilwrap"><a href="#section-123" class="pilcrow">&#182;</a></div><p>if this is an HTML marker, copy it</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/~K(\d+)K/g</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">grafsOut</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/\S/</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">str</span> <span class="o">=</span> <span class="nx">_RunSpanGamut</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
      <span class="nx">str</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n/g</span><span class="p">,</span><span class="s2">&quot;&lt;br /&gt;&quot;</span><span class="p">);</span>  <span class="c1">// ** GFM **</span>
      <span class="nx">str</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^([ \t]*)/g</span><span class="p">,</span><span class="s2">&quot;&lt;p&gt;&quot;</span><span class="p">);</span>
      <span class="nx">str</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/p&gt;&quot;</span>
      <span class="nx">grafsOut</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">}</span></pre></div></td></tr><tr id="section-124"><td class="docs"><div class="pilwrap"><a href="#section-124" class="pilcrow">&#182;</a></div><p>Unhashify HTML blocks</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">end</span> <span class="o">=</span> <span class="nx">grafsOut</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">end</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-125"><td class="docs"><div class="pilwrap"><a href="#section-125" class="pilcrow">&#182;</a></div><p>if this is a marker for an html block...</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">while</span> <span class="p">(</span><span class="nx">grafsOut</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">search</span><span class="p">(</span><span class="sr">/~K(\d+)K/</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">blockText</span> <span class="o">=</span> <span class="nx">g_html_blocks</span><span class="p">[</span><span class="nb">RegExp</span><span class="p">.</span><span class="nx">$1</span><span class="p">];</span>
      <span class="nx">blockText</span> <span class="o">=</span> <span class="nx">blockText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\$/g</span><span class="p">,</span><span class="s2">&quot;$$$$&quot;</span><span class="p">);</span> <span class="c1">// Escape any dollar signs</span>
      <span class="nx">grafsOut</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">grafsOut</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/~K\d+K/</span><span class="p">,</span><span class="nx">blockText</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">grafsOut</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n\n&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">_EncodeAmpsAndAngles</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-126"><td class="docs"><div class="pilwrap"><a href="#section-126" class="pilcrow">&#182;</a></div><p>Smart processing for ampersands and angle brackets that need to be encoded.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-127"><td class="docs"><div class="pilwrap"><a href="#section-127" class="pilcrow">&#182;</a></div><p>Ampersand-encoding based entirely on Nat Irons's Amputator MT plugin:
  http://bumppo.net/projects/amputator/</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g</span><span class="p">,</span><span class="s2">&quot;&amp;amp;&quot;</span><span class="p">);</span></pre></div></td></tr><tr id="section-128"><td class="docs"><div class="pilwrap"><a href="#section-128" class="pilcrow">&#182;</a></div><p>Encode naked &lt;'s</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;(?![a-z\/?\$!])/gi</span><span class="p">,</span><span class="s2">&quot;&amp;lt;&quot;</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">_EncodeBackslashEscapes</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-129"><td class="docs"><div class="pilwrap"><a href="#section-129" class="pilcrow">&#182;</a></div><p>Parameter:  String.
  Returns:    The string, with after processing the following backslash
           escape sequences.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-130"><td class="docs"><div class="pilwrap"><a href="#section-130" class="pilcrow">&#182;</a></div><p>attacklab: The polite way to do this is with the new
escapeCharacters() function:</p>

<pre><code>text = escapeCharacters(text,"\\",true);
text = escapeCharacters(text,"`*_{}[]()&gt;#+-.!",true);
</code></pre>

<p>...but we're sidestepping its use of the (slow) RegExp constructor
as an optimization for Firefox.  This function gets called a LOT.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\(\\)/g</span><span class="p">,</span><span class="nx">escapeCharacters_callback</span><span class="p">);</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\([`*_{}\[\]()&gt;#+-.!])/g</span><span class="p">,</span><span class="nx">escapeCharacters_callback</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">_DoAutoLinks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;((https?|ftp|dict):[^&#39;&quot;&gt;\s]+)&gt;/gi</span><span class="p">,</span><span class="s2">&quot;&lt;a href=\&quot;$1\&quot;&gt;$1&lt;/a&gt;&quot;</span><span class="p">);</span></pre></div></td></tr><tr id="section-131"><td class="docs"><div class="pilwrap"><a href="#section-131" class="pilcrow">&#182;</a></div><p>Email addresses: <a href="&#109;&#x61;i&#x6C;&#x74;&#x6F;:&#x61;&#100;&#100;&#114;&#101;&#x73;&#x73;&#64;&#x64;o&#x6D;&#x61;&#x69;&#x6E;.&#x66;&#x6F;&#111;">&#x61;&#100;&#100;&#114;&#101;&#x73;&#x73;&#64;&#x64;o&#x6D;&#x61;&#x69;&#x6E;.&#x66;&#x6F;&#111;</a></p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-132"><td class="docs"><div class="pilwrap"><a href="#section-132" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>text = text.replace(/<br />            &lt;<br />            (?:mailto:)?<br />            (<br />                [-.\w]+<br />                \@<br />                [-a-z0-9]+(.[-a-z0-9]+)*.[a-z]+<br />            )<br />            ><br />        /gi, _DoAutoLinks_callback());</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;(?:mailto:)?([-.\w]+\@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)&gt;/gi</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">m1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_EncodeEmailAddress</span><span class="p">(</span> <span class="nx">_UnescapeSpecialChars</span><span class="p">(</span><span class="nx">m1</span><span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">);</span>

  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">_EncodeEmailAddress</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-133"><td class="docs"><div class="pilwrap"><a href="#section-133" class="pilcrow">&#182;</a></div><p>Input: an email address, e.g. "foo@example.com"</p>

<p>Output: the email address as a mailto link, with each character
of the address encoded as either a decimal or hex entity, in
the hopes of foiling most address harvesting spam bots. E.g.:</p>

<p><a href="&#x6D;&#97;&#105;&#108;&#x74;&#111;:&#102;&#111;&#111;&#64;&#101;
   x&#x61;&#109;&#x70;&#108;&#x65;&#x2E;&#99;&#111;&#109;">&#102;&#111;&#111;
   &#64;&#101;x&#x61;&#109;&#x70;&#108;&#x65;&#x2E;&#99;&#111;&#109;</a></p>

<p>Based on a filter by Matthew Wickline, posted to the BBEdit-Talk
 mailing list: <a href="http://tinyurl.com/yu7ue">http://tinyurl.com/yu7ue</a></p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-134"><td class="docs"><div class="pilwrap"><a href="#section-134" class="pilcrow">&#182;</a></div><p>attacklab: why can't javascript speak hex?</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">char2hex</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">hexDigits</span> <span class="o">=</span> <span class="s1">&#39;0123456789ABCDEF&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">dec</span> <span class="o">=</span> <span class="nx">ch</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span><span class="p">(</span><span class="nx">hexDigits</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">dec</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="nx">hexDigits</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">dec</span><span class="o">&amp;</span><span class="mi">15</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">encode</span> <span class="o">=</span> <span class="p">[</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">ch</span><span class="p">){</span><span class="k">return</span> <span class="s2">&quot;&amp;#&quot;</span><span class="o">+</span><span class="nx">ch</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;;&quot;</span><span class="p">;},</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">ch</span><span class="p">){</span><span class="k">return</span> <span class="s2">&quot;&amp;#x&quot;</span><span class="o">+</span><span class="nx">char2hex</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;;&quot;</span><span class="p">;},</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">ch</span><span class="p">){</span><span class="k">return</span> <span class="nx">ch</span><span class="p">;}</span>
  <span class="p">];</span>

  <span class="nx">addr</span> <span class="o">=</span> <span class="s2">&quot;mailto:&quot;</span> <span class="o">+</span> <span class="nx">addr</span><span class="p">;</span>

  <span class="nx">addr</span> <span class="o">=</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/./g</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ch</span> <span class="o">==</span> <span class="s2">&quot;@&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-135"><td class="docs"><div class="pilwrap"><a href="#section-135" class="pilcrow">&#182;</a></div><p>this <em>must</em> be encoded. I insist.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">ch</span> <span class="o">=</span> <span class="nx">encode</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">2</span><span class="p">)](</span><span class="nx">ch</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">ch</span> <span class="o">!=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-136"><td class="docs"><div class="pilwrap"><a href="#section-136" class="pilcrow">&#182;</a></div><p>leave ':' alone (to spot mailto: later)</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">();</span></pre></div></td></tr><tr id="section-137"><td class="docs"><div class="pilwrap"><a href="#section-137" class="pilcrow">&#182;</a></div><p>roughly 10% raw, 45% hex, 45% dec</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">ch</span> <span class="o">=</span>  <span class="p">(</span>
          <span class="nx">r</span> <span class="o">&gt;</span> <span class="p">.</span><span class="mi">9</span>  <span class="o">?</span> <span class="nx">encode</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span><span class="nx">ch</span><span class="p">)</span>   <span class="o">:</span>
          <span class="nx">r</span> <span class="o">&gt;</span> <span class="p">.</span><span class="mi">45</span> <span class="o">?</span> <span class="nx">encode</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="nx">ch</span><span class="p">)</span>   <span class="o">:</span>
                <span class="nx">encode</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="nx">ch</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">ch</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">addr</span> <span class="o">=</span> <span class="s2">&quot;&lt;a href=\&quot;&quot;</span> <span class="o">+</span> <span class="nx">addr</span> <span class="o">+</span> <span class="s2">&quot;\&quot;&gt;&quot;</span> <span class="o">+</span> <span class="nx">addr</span> <span class="o">+</span> <span class="s2">&quot;&lt;/a&gt;&quot;</span><span class="p">;</span>
  <span class="nx">addr</span> <span class="o">=</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&quot;&gt;.+:/g</span><span class="p">,</span><span class="s2">&quot;\&quot;&gt;&quot;</span><span class="p">);</span> <span class="c1">// strip the mailto: from the visible part</span>

  <span class="k">return</span> <span class="nx">addr</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">_UnescapeSpecialChars</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-138"><td class="docs"><div class="pilwrap"><a href="#section-138" class="pilcrow">&#182;</a></div><p>Swap back in all the special characters we've hidden.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/~E(\d+)E/g</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">m1</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">charCodeToReplace</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">m1</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">charCodeToReplace</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">);</span>
  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">_Outdent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-139"><td class="docs"><div class="pilwrap"><a href="#section-139" class="pilcrow">&#182;</a></div><p>Remove one level of line-leading tabs or spaces</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-140"><td class="docs"><div class="pilwrap"><a href="#section-140" class="pilcrow">&#182;</a></div><p>attacklab: hack around Konqueror 3.5.4 bug:
"----------bug".replace(/^-/g,"") == "bug"</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^(\t|[ ]{1,4})/gm</span><span class="p">,</span><span class="s2">&quot;~0&quot;</span><span class="p">);</span> <span class="c1">// attacklab: g_tab_width</span></pre></div></td></tr><tr id="section-141"><td class="docs"><div class="pilwrap"><a href="#section-141" class="pilcrow">&#182;</a></div><p>attacklab: clean up hack</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/~0/g</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">_Detab</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-142"><td class="docs"><div class="pilwrap"><a href="#section-142" class="pilcrow">&#182;</a></div><p>attacklab: Detab's completely rewritten for speed.
In perl we could fix it by anchoring the regexp with \G.
In javascript we're less fortunate.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-143"><td class="docs"><div class="pilwrap"><a href="#section-143" class="pilcrow">&#182;</a></div><p>expand first n-1 tabs</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\t(?=\t)/g</span><span class="p">,</span><span class="s2">&quot;    &quot;</span><span class="p">);</span> <span class="c1">// attacklab: g_tab_width</span></pre></div></td></tr><tr id="section-144"><td class="docs"><div class="pilwrap"><a href="#section-144" class="pilcrow">&#182;</a></div><p>replace the nth with two sentinels</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\t/g</span><span class="p">,</span><span class="s2">&quot;~A~B&quot;</span><span class="p">);</span></pre></div></td></tr><tr id="section-145"><td class="docs"><div class="pilwrap"><a href="#section-145" class="pilcrow">&#182;</a></div><p>use the sentinel to anchor our regex so it doesn't explode</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/~B(.+?)~A/g</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">m1</span><span class="p">,</span><span class="nx">m2</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">leadingText</span> <span class="o">=</span> <span class="nx">m1</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">numSpaces</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="nx">leadingText</span><span class="p">.</span><span class="nx">length</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>  <span class="c1">// attacklab: g_tab_width</span></pre></div></td></tr><tr id="section-146"><td class="docs"><div class="pilwrap"><a href="#section-146" class="pilcrow">&#182;</a></div><p>there <em>must</em> be a better way to do this:</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">numSpaces</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">leadingText</span><span class="o">+=</span><span class="s2">&quot; &quot;</span><span class="p">;</span>

      <span class="k">return</span> <span class="nx">leadingText</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">);</span></pre></div></td></tr><tr id="section-147"><td class="docs"><div class="pilwrap"><a href="#section-147" class="pilcrow">&#182;</a></div><p>clean up sentinels</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/~A/g</span><span class="p">,</span><span class="s2">&quot;    &quot;</span><span class="p">);</span>  <span class="c1">// attacklab: g_tab_width</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/~B/g</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-148"><td class="docs"><div class="pilwrap"><a href="#section-148" class="pilcrow">&#182;</a></div><p>attacklab: Utility functions</p>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">escapeCharacters</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">charsToEscape</span><span class="p">,</span> <span class="nx">afterBackslash</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-149"><td class="docs"><div class="pilwrap"><a href="#section-149" class="pilcrow">&#182;</a></div><p>First we have to escape the escape characters so that
we can build a character class out of them</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">regexString</span> <span class="o">=</span> <span class="s2">&quot;([&quot;</span> <span class="o">+</span> <span class="nx">charsToEscape</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([\[\]\\])/g</span><span class="p">,</span><span class="s2">&quot;\\$1&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;])&quot;</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">afterBackslash</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">regexString</span> <span class="o">=</span> <span class="s2">&quot;\\\\&quot;</span> <span class="o">+</span> <span class="nx">regexString</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">regex</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">regexString</span><span class="p">,</span><span class="s2">&quot;g&quot;</span><span class="p">);</span>
  <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">regex</span><span class="p">,</span><span class="nx">escapeCharacters_callback</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">escapeCharacters_callback</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">wholeMatch</span><span class="p">,</span><span class="nx">m1</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">charCodeToEscape</span> <span class="o">=</span> <span class="nx">m1</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="k">return</span> <span class="s2">&quot;~E&quot;</span><span class="o">+</span><span class="nx">charCodeToEscape</span><span class="o">+</span><span class="s2">&quot;E&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">}</span> <span class="c1">// end of Showdown.converter</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Fri Jan 04 2013 21:20:49 GMT+0100 (CET)  </div></div></body></html>